<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>SKIBIDI ENT üîµ</title>
<style>
body{font-family:Arial;background:#e8f0ff;margin:0}
header{background:#0b5ed7;color:white;padding:10px;text-align:center;font-size:24px}
.box{max-width:1000px;margin:20px auto;background:white;border-radius:10px;padding:15px}
button{background:#0b5ed7;color:white;border:none;padding:6px 10px;border-radius:5px;margin:2px}
.tab{display:inline-block;margin:5px;padding:6px 10px;background:#cfe2ff;border-radius:5px;cursor:pointer}
.tab.active{background:white;border-bottom:3px solid #0b5ed7}
.star{color:gold;font-size:18px}
.trash{cursor:pointer;color:red}
textarea{width:300px;height:50px;display:block;margin-top:5px;margin-bottom:5px}
.status-valid{color:green;font-weight:bold}
.status-refuse{color:red;font-weight:bold}
.status-wait{color:orange;font-weight:bold}
</style>
</head>
<body>

<header>üìö SKIBIDI ENT üîµ</header>

<div class="box" id="login">
  <h3>Connexion</h3>
  <input id="id" placeholder="Identifiant">
  <input id="pw" type="password" placeholder="Mot de passe">
  <button onclick="connect()">Se connecter</button>
  <p id="err" style="color:red"></p>
</div>

<div class="box" id="app" style="display:none">
  <div id="tabs"></div>
  <div id="content"></div>
</div>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion, onSnapshot } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCbyZ8lqCMvfYEcLJULTaPtDg5jCtEzKeM",
  authDomain: "skibidi-4d0ef.firebaseapp.com",
  projectId: "skibidi-4d0ef",
  storageBucket: "skibidi-4d0ef.appspot.com",
  messagingSenderId: "349129487956",
  appId: "1:349129487956:web:12986c9cc87a77bab8dfc1"
};
const appFirebase = initializeApp(firebaseConfig);
const db = getFirestore(appFirebase);

// USERS
const users={
  sahli:{pass:"sahli123",role:"prof",name:"M. Sahli"},
  bouhmadi:{pass:"bouhmadi123",role:"prof",name:"M. Bouhmadi"},
  ouachaou:{pass:"secretaire",role:"secretaire",name:"M. Ouachaou"},
  nassim:{pass:"nassim",role:"eleve",name:"Nassim"},
  arthur:{pass:"arthur",role:"eleve",name:"Arthur"},
  sarah:{pass:"sarah",role:"eleve",name:"Sarah"},
  rayan:{pass:"rayan",role:"eleve",name:"Rayan"},
  nathan:{pass:"nathan",role:"eleve",name:"Nathan"},
  aymend:{pass:"aymend",role:"eleve",name:"Aymen Dib"},
  aymenf:{pass:"aymenf",role:"eleve",name:"Aymen Ferhane"},
  nael:{pass:"nael",role:"eleve",name:"Nael"}
};

let current=null;

function eleves(){return Object.keys(users).filter(u=>users[u].role=="eleve");}

// CONNECT
function connect(){
  if(!users[id.value]||users[id.value].pass!=pw.value){err.textContent="Erreur";return;}
  current=id.value;
  login.style.display="none";
  app.style.display="block";
  buildTabs();
}

// TABS
function buildTabs(){
  let r=users[current].role;
  let t=["Notes","√âtoiles","Missions","Emploi du temps","Appel"];
  if(r=="secretaire") t=["Justification"];
  if(r=="prof" || current=="sahli" || r=="eleve") t.push("Mots");
  tabs.innerHTML = t.map(x=>`<span class="tab" onclick="openTab('${x}')">${x}</span>`).join("");
  openTab(t[0]);
}

function openTab(n){
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  [...tabs.children].find(x=>x.textContent==n).classList.add("active");
  if(n=="Notes") notesTab();
  if(n=="√âtoiles") starsTab();
  if(n=="Missions") missionsTab();
  if(n=="Emploi du temps") edtTab();
  if(n=="Appel") appelTab();
  if(n=="Justification") justifTab();
  if(n=="Mots") buildMotTab();
}

/* --- NOTES --- */
async function notesTab(){
  let h="<h3>üìä Notes</h3>";
  if(users[current].role=="prof"){
    h+=`<select id="e">${eleves().map(e=>`<option>${e}</option>`).join("")}</select>
        <input id="v" placeholder="15/20">
        <button onclick="addNote()">‚ûï</button>`;
    if(current=="sahli") h+=`<button onclick="resetNotes()">üóëÔ∏è Reset</button>`;
  }
  h+="<ul id='notesList'></ul>";
  content.innerHTML=h;

  // Affichage notes
  eleves().forEach(async e=>{
    const docRef = doc(db, "notes", e);
    const docSnap = await getDoc(docRef);
    let notes = docSnap.exists()?docSnap.data().notes||[]:[];
    notes.forEach((n,i)=>{
      let li = document.createElement("li");
      li.innerHTML=`${users[e].name} : ${n}`;
      if(users[current].role=="prof"){
        let del = document.createElement("span");
        del.className="trash";
        del.textContent="üóëÔ∏è";
        del.onclick = async ()=>{
          notes.splice(i,1);
          await setDoc(docRef,{notes:notes},{merge:true});
          notesTab();
        };
        li.prepend(del);
      }
      document.getElementById("notesList").appendChild(li);
    });
  });
}
async function addNote(){
  let e=document.getElementById("e").value;
  let v=document.getElementById("v").value;
  const docRef = doc(db,"notes",e);
  await setDoc(docRef,{notes:arrayUnion(v)},{merge:true});
  notesTab();
}
async function resetNotes(){
  for(let e of eleves()){
    await setDoc(doc(db,"notes",e),{notes:[]},{merge:true});
  }
  notesTab();
}

/* --- √âTOILES --- */
async function starsTab(){
  let h="<h3>‚≠ê √âtoiles</h3>";
  if(users[current].role=="prof"){
    h+=`<select id="e">${eleves().map(e=>`<option>${e}</option>`).join("")}</select>
        <select id="v"><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option></select>
        <button onclick="addStar()">‚ûï</button>`;
    if(current=="sahli") h+=`<button onclick="resetStars()">üóëÔ∏è Reset</button>`;
  }
  h+="<ul id='starsList'></ul>";
  content.innerHTML=h;

  eleves().forEach(async e=>{
    const docRef=doc(db,"stars",e);
    const docSnap=await getDoc(docRef);
    let stars=docSnap.exists()?docSnap.data().stars||[]:[];
    stars.forEach((s,i)=>{
      let li=document.createElement("li");
      li.innerHTML=`${users[e].name} : ${"‚òÖ".repeat(s)}`;
      if(users[current].role=="prof"){
        let del = document.createElement("span");
        del.className="trash";
        del.textContent="üóëÔ∏è";
        del.onclick=async ()=>{
          stars.splice(i,1);
          await setDoc(docRef,{stars:stars},{merge:true});
          starsTab();
        };
        li.prepend(del);
      }
      document.getElementById("starsList").appendChild(li);
    });
  });
}
async function addStar(){
  let e=document.getElementById("e").value;
  let v=parseInt(document.getElementById("v").value);
  const docRef = doc(db,"stars",e);
  await setDoc(docRef,{stars:arrayUnion(v)},{merge:true});
  starsTab();
}
async function resetStars(){
  for(let e of eleves()){
    await setDoc(doc(db,"stars",e),{stars:[]},{merge:true});
  }
  starsTab();
}

/* --- MOTS --- */
function buildMotTab(){
  let h="<h3>‚úâÔ∏è Mots dans le carnet</h3>";
  if(users[current].role=="prof" || current=="sahli"){
    h+=`<select id="motEleve">${eleves().map(e=>`<option>${e}</option>`).join("")}</select>
        <textarea id="motTexte" placeholder="Texte du mot"></textarea>
        <button onclick="envoyerMot()">Envoyer ‚úâÔ∏è</button>`;
  }
  h+="<ul id='motsList'></ul>";
  content.innerHTML=h;
  showMots();
}

async function showMots(){
  let ul=document.getElementById("motsList");
  ul.innerHTML="";
  for(let e of eleves()){
    const docRef = doc(db,"mots",e);
    const docSnap = await getDoc(docRef);
    if(!docSnap.exists()) continue;
    let mot=docSnap.data();
    let li=document.createElement("li");
    let text=`${users[e].name} : "${mot.texte}" - ${mot.statut}`;
    if(current=="sahli") text=`<span class="trash" onclick="delMot('${e}')">üóëÔ∏è</span> `+text;
    if((users[current].role=="prof" || current=="sahli") && mot.statut=="Sign√©, en attente validation prof")
      text+=` <button onclick="valideMot('${e}')">‚úÖ</button> <button onclick="refuseMot('${e}')">‚ùå</button>`;
    if(users[current].role=="eleve" && current==e && mot.statut=="Pas encore sign√©")
      text+=` <button onclick="signerMot('${e}')">Signer ‚úçÔ∏è</button>`;
    li.innerHTML=text;
    ul.appendChild(li);
  }
}

async function envoyerMot(){
  let e=document.getElementById("motEleve").value;
  let texte=document.getElementById("motTexte").value.trim();
  if(!texte) return alert("√âcrire un mot !");
  await setDoc(doc(db,"mots",e),{texte:texte,statut:"Pas encore sign√©"});
  showMots();
}

async function signerMot(e){
  await updateDoc(doc(db,"mots",e),{statut:"Sign√©, en attente validation prof"});
  showMots();
}

async function valideMot(e){
  await updateDoc(doc(db,"mots",e),{statut:"Valid√© ‚úÖ"});
  showMots();
}

async function refuseMot(e){
  await updateDoc(doc(db,"mots",e),{statut:"Refus√© ‚ùå"});
  showMots();
}

async function delMot(e){
  await setDoc(doc(db,"mots",e),{}, {merge:true});
  showMots();
}

</script>
</body>
</html>
